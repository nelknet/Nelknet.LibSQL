<Project>
  <Target Name="DownloadNativeLibrary">
    <PropertyGroup>
      <NativeLibsDir>$(MSBuildProjectDirectory)\obj\runtimes\$(Rid)\native</NativeLibsDir>
      <LibSQLVersion Condition="'$(LibSQLVersion)' == ''">0.2.2</LibSQLVersion>
      <LibraryFileName Condition="'$(Rid)' == 'win-x64'">libsql.dll</LibraryFileName>
      <LibraryFileName Condition="'$(Rid)' == 'win-x86'">libsql.dll</LibraryFileName>
      <LibraryFileName Condition="'$(Rid)' == 'win-arm64'">libsql.dll</LibraryFileName>
      <LibraryFileName Condition="'$(Rid)' == 'linux-x64'">liblibsql.so</LibraryFileName>
      <LibraryFileName Condition="'$(Rid)' == 'linux-arm64'">liblibsql.so</LibraryFileName>
      <LibraryFileName Condition="'$(Rid)' == 'linux-arm'">liblibsql.so</LibraryFileName>
      <LibraryFileName Condition="'$(Rid)' == 'osx-x64'">liblibsql.dylib</LibraryFileName>
      <LibraryFileName Condition="'$(Rid)' == 'osx-arm64'">liblibsql.dylib</LibraryFileName>
      <DownloadUrl>$(LibSQLReleaseUrl)</DownloadUrl>
      <ArchiveFileName>$(NativeLibsDir)\libsql-$(Rid).zip</ArchiveFileName>
    </PropertyGroup>

    <Message Text="Downloading libSQL native library for $(Rid) from $(DownloadUrl)" Importance="high" />
    
    <MakeDir Directories="$(NativeLibsDir)" />
    
    <!-- Download the native library archive -->
    <DownloadFile 
      SourceUrl="$(DownloadUrl)" 
      DestinationFolder="$(NativeLibsDir)"
      DestinationFileName="$(ArchiveFileName)"
      Retries="3"
      RetryDelayMilliseconds="1000"
      SkipUnchangedFiles="true"
      Condition="!Exists('$(ArchiveFileName)')" />
    
    <!-- Extract the archive -->
    <Unzip 
      SourceFiles="$(ArchiveFileName)" 
      DestinationFolder="$(NativeLibsDir)"
      OverwriteReadOnlyFiles="true"
      Condition="Exists('$(ArchiveFileName)')" />
    
    <!-- Clean up the archive file -->
    <Delete Files="$(ArchiveFileName)" />
    
    <Message Text="Successfully downloaded libSQL native library for $(Rid)" Importance="high" />
  </Target>
</Project>